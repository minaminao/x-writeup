# TJCTF 2023 - crypto - aluminum-isopropoxide

```cpp
#include <iostream>
#include <cinttypes>
#include <string>
#include <filesystem>
#include <fstream>
#include <sys/stat.h>
#include <vector>
#include <cstring>
using namespace std;
using namespace std::filesystem;

typedef uint8_t Byte;

void make_key(Byte *S, const std::string &key)
{
	for (int i = 0; i < 255; i++)
		S[i] = i;

	Byte j = 0;
	for (int i = 0; i < 255; i++)
	{
		j = (j ^ S[i] ^ key[i % key.length()]) % 256;
		std::swap(S[i], S[j]);
	}
}

Byte S_box[256] = {24, 250, 101, 19, 98, 246, 141, 58, 129, 74, 227, 160, 55, 167, 62, 57, 237, 156, 32, 46, 90, 67, 22, 3, 149, 212, 36, 210, 27, 99, 168, 109, 125, 52, 173, 184, 214, 86, 112, 70, 5, 252, 6, 170, 30, 251, 103, 43, 244, 213, 211, 198, 16, 242, 65, 118, 68, 233, 148, 18, 61, 17, 48, 80, 187, 206, 72, 171, 234, 140, 116, 35, 107, 130, 113, 199, 51, 114, 232, 134, 215, 197, 31, 150, 247, 79, 26, 110, 142, 29, 9, 117, 248, 186, 105, 120, 15, 179, 207, 128, 10, 254, 83, 222, 178, 123, 100, 39, 228, 84, 93, 97, 60, 94, 180, 146, 185, 38, 203, 235, 249, 89, 226, 1, 106, 12, 216, 221, 8, 45, 13, 2, 14, 75, 49, 33, 127, 163, 111, 85, 255, 253, 166, 151, 40, 23, 194, 34, 139, 95, 145, 193, 159, 133, 69, 245, 196, 102, 91, 11, 157, 96, 47, 152, 154, 59, 181, 28, 126, 200, 158, 88, 224, 231, 41, 190, 240, 191, 188, 143, 164, 189, 217, 54, 66, 241, 209, 104, 78, 87, 82, 230, 182, 220, 53, 147, 21, 136, 76, 0, 115, 169, 71, 44, 223, 175, 92, 25, 177, 64, 201, 77, 138, 144, 204, 229, 81, 20, 183, 205, 124, 243, 4, 172, 174, 108, 132, 176, 135, 161, 162, 7, 236, 195, 238, 56, 42, 131, 218, 155, 121, 153, 239, 50, 219, 225, 37, 202, 63, 137, 192, 208, 119, 122, 165, 73};

void enc(Byte *S, Byte *out, int amount)
{
	Byte i = 0;
	Byte j = 0;
	int ctr = 0;
	while (ctr < amount)
	{
		i = (i * j) % 256;
		j = (i + S[j]) % 256;
		// std::swap(S[i],S[j]);
		Byte K = (S[i] & S[j]);
		out[ctr] ^= S_box[K];
		ctr++;
	}
}

Byte key[256];
int main()
{

	std::string path = current_path();

	std::vector<std::string> files;
	for (const auto &file : directory_iterator(path))
		files.push_back(std::string(file.path()));

	for (const auto &file : files)
	{
		std::cout << file << "\n";
		struct stat results;
		std::ifstream in(file);
		std::ofstream out(file + ".enc", std::ofstream::binary);
		if (stat(file.c_str(), &results) == 0)
		{
			uint8_t *buffer = new uint8_t[results.st_size];
			in.read((char *)buffer, results.st_size);

			make_key(key, std::to_string(rand()));
			enc(key, buffer, results.st_size);

			out.write((char *)buffer, results.st_size);
			delete[] buffer;
		}
		in.close();
		out.close();
	}

	return 0;
}
```

Since this cpp code doesn't call `srand`, the output of `rand` is fixed even if the program is reran, which means we can recover `key` used for encryption.
I inserted the code that printed `key` and 3 keys for encryption:

```cpp
      make_key(key, std::to_string(rand()));
      printf("[");
      for (int i = 0; i < 256; i++) {
        printf("%d, ", key[i]);
      }
      printf("]\n");
      printf("%d\n", results.st_size);
      enc(key, buffer, results.st_size);
```

Since the flag starts with `tfctf{`, we can recover the first 6 bytes of `K` in the following.

```cpp
	while (ctr < amount)
	{
		i = (i * j) % 256;
		j = (i + S[j]) % 256;
		// std::swap(S[i],S[j]);
		Byte K = (S[i] & S[j]);
		out[ctr] ^= S_box[K];
		ctr++;
	}
```

Note that `i` is always 0 because of `swap` is commented out. Then `S[i]` (=`key[i]`) is fixed for encrypted 34 characters. This means the candidates of `K` is determined only by `key[0]`. From here we can tell which encrypted file is a real flag (`flag1.txt.enc`).

All we have to do is reveal which key is used for encrypting `flag1.txt.enc`. I tried to decrypt it by all keys and found the flag.


```python
key0 = [30, 25, 58, 40, 1, 56, 35, 19, 48, 3, 27, 6, 57, 37, 12, 7, 52, 59, 39, 38, 51, 2, 41, 54, 32, 8, 20, 36, 46, 44, 16, 18, 24, 53, 49, 15, 23, 17, 14, 50, 43, 11, 55, 13, 26, 28, 31, 29, 181, 193, 229, 225, 235, 239, 61, 245, 249, 162, 251, 5, 247, 241, 34, 253, 74, 76, 72, 63, 68, 70, 42, 64, 66, 78, 0, 47, 62, 33, 22, 73, 84, 10, 86, 94, 90, 9, 92, 21, 95, 80, 83, 71, 88, 77, 67, 4, 96, 69, 104, 110, 109, 98, 102, 106, 45, 75, 79, 108, 93, 87, 89, 105, 116, 124, 60, 112, 126, 103, 120, 107, 123, 85, 125, 119, 114, 65, 91, 99, 128, 130, 97, 132, 142, 140, 139, 111, 118, 133, 141, 127, 136, 121, 115, 134, 154, 156, 152, 143, 148, 150, 129, 144, 146, 158, 131, 135, 122, 137, 117, 153, 164, 81, 166, 174, 170, 138, 172, 100, 175, 160, 163, 151, 168, 157, 147, 82, 176, 149, 184, 190, 189, 178, 182, 186, 101, 155, 159, 188, 173, 167, 169, 185, 196, 204, 113, 192, 206, 183, 200, 187, 203, 165, 205, 199, 194, 145, 171, 179, 208, 210, 177, 212, 222, 220, 219, 191, 198, 213, 221, 207, 216, 201, 195, 214, 234, 236, 232, 223, 228, 230, 209, 224, 226, 238, 211, 215, 202, 217, 197, 233, 244, 161, 246, 254, 250, 218, 252, 180, 0, 240, 243, 231, 248, 237, 227, 242]
key1 = [29, 19, 57, 26, 53, 13, 63, 4, 62, 15, 49, 31, 25, 41, 10, 36, 24, 1, 18, 5, 40, 3, 42, 8, 45, 58, 51, 9, 16, 48, 60, 12, 125, 109, 99, 105, 30, 54, 67, 46, 35, 23, 103, 0, 107, 115, 91, 96, 205, 229, 201, 20, 237, 245, 240, 250, 214, 249, 253, 226, 247, 191, 178, 195, 66, 64, 86, 72, 82, 11, 81, 33, 80, 65, 70, 22, 92, 27, 87, 71, 94, 7, 76, 43, 84, 55, 88, 34, 90, 83, 61, 6, 68, 56, 38, 74, 108, 73, 121, 17, 114, 77, 104, 59, 100, 75, 113, 124, 112, 101, 98, 69, 120, 78, 126, 97, 118, 106, 123, 122, 116, 47, 52, 111, 95, 79, 102, 119, 131, 32, 138, 37, 134, 129, 137, 117, 130, 136, 93, 50, 141, 89, 143, 44, 156, 128, 158, 148, 28, 135, 152, 150, 154, 149, 142, 127, 146, 2, 159, 147, 172, 162, 160, 153, 164, 174, 173, 145, 170, 161, 132, 163, 133, 85, 168, 140, 185, 14, 182, 180, 190, 166, 186, 184, 39, 151, 189, 157, 21, 187, 188, 110, 196, 171, 200, 179, 197, 204, 207, 183, 206, 181, 203, 194, 139, 177, 192, 193, 222, 155, 220, 199, 216, 209, 212, 218, 219, 169, 167, 208, 165, 198, 210, 176, 236, 175, 239, 215, 231, 234, 228, 224, 233, 238, 202, 227, 225, 144, 223, 217, 243, 235, 254, 252, 246, 213, 248, 211, 244, 230, 251, 232, 221, 241, 242, 242]
key2 = [5, 6, 9, 28, 23, 49, 61, 14, 4, 43, 25, 58, 12, 0, 27, 29, 45, 2, 46, 24, 47, 54, 34, 40, 42, 19, 22, 10, 37, 15, 18, 36, 20, 63, 57, 31, 60, 38, 52, 41, 44, 1, 26, 35, 11, 62, 16, 55, 251, 245, 199, 197, 249, 247, 208, 240, 183, 232, 227, 231, 77, 248, 228, 243, 66, 21, 70, 7, 71, 78, 74, 65, 64, 68, 76, 33, 72, 48, 13, 3, 92, 84, 8, 90, 82, 79, 88, 94, 89, 56, 80, 59, 53, 32, 51, 91, 98, 69, 100, 86, 99, 95, 111, 104, 108, 96, 102, 83, 87, 110, 50, 101, 121, 116, 118, 105, 103, 107, 125, 109, 123, 85, 127, 126, 124, 115, 39, 120, 129, 122, 132, 73, 140, 93, 143, 106, 138, 97, 139, 114, 133, 113, 134, 131, 150, 75, 158, 17, 153, 81, 154, 156, 146, 145, 155, 141, 149, 112, 144, 142, 161, 136, 173, 130, 172, 174, 135, 137, 170, 67, 164, 159, 162, 157, 166, 117, 177, 128, 179, 180, 176, 171, 184, 30, 186, 188, 182, 119, 178, 175, 190, 165, 201, 196, 198, 160, 152, 189, 205, 187, 203, 168, 207, 206, 204, 195, 185, 200, 209, 202, 212, 181, 220, 163, 223, 191, 218, 167, 219, 194, 213, 193, 214, 211, 230, 148, 238, 147, 233, 151, 234, 236, 226, 225, 235, 221, 229, 192, 224, 222, 241, 216, 253, 210, 252, 254, 215, 217, 250, 169, 244, 239, 242, 237, 246, 242]
sbox = [24, 250, 101, 19, 98, 246, 141, 58, 129, 74, 227, 160, 55, 167, 62, 57, 237, 156, 32, 46, 90, 67, 22, 3, 149, 212, 36, 210, 27, 99, 168, 109, 125, 52, 173, 184, 214, 86, 112, 70, 5, 252, 6, 170, 30, 251, 103, 43, 244, 213, 211, 198, 16, 242, 65, 118, 68, 233, 148, 18, 61, 17, 48, 80, 187, 206, 72, 171, 234, 140, 116, 35, 107, 130, 113, 199, 51, 114, 232, 134, 215, 197, 31, 150, 247, 79, 26, 110, 142, 29, 9, 117, 248, 186, 105, 120, 15, 179, 207, 128, 10, 254, 83, 222, 178, 123, 100, 39, 228, 84, 93, 97, 60, 94, 180, 146, 185, 38, 203, 235, 249, 89, 226, 1, 106, 12, 216, 221, 8, 45, 13, 2, 14, 75, 49, 33, 127, 163, 111, 85, 255, 253, 166, 151, 40, 23, 194, 34, 139, 95, 145, 193, 159, 133, 69, 245, 196, 102, 91, 11, 157, 96, 47, 152, 154, 59, 181, 28, 126, 200, 158, 88, 224, 231, 41, 190, 240, 191, 188, 143, 164, 189, 217, 54, 66, 241, 209, 104, 78, 87, 82, 230, 182, 220, 53, 147, 21, 136, 76, 0, 115, 169, 71, 44, 223, 175, 92, 25, 177, 64, 201, 77, 138, 144, 204, 229, 81, 20, 183, 205, 124, 243, 4, 172, 174, 108, 132, 176, 135, 161, 162, 7, 236, 195, 238, 56, 42, 131, 218, 155, 121, 153, 239, 50, 219, 225, 37, 202, 63, 137, 192, 208, 119, 122, 165, 73]

with open("flag1.txt.enc", "rb") as fp:
    enc = fp.read()


def dec(key, enc, amount):
    i = 0
    j = 0
    ctr = 0
    out = b""
    while ctr < amount:
        i = (i * j) % 256
        j = (i + key[j]) % 256
        K = key[i] & key[j]
        out += bytes([enc[ctr] ^ sbox[K]])
        ctr += 1
    return out


for key in [key0, key1, key2]:
    print(dec(key, enc, len(enc)))
```

`tjctf{flag_under_mountain_of_dust}`
